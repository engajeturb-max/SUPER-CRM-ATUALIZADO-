import{ao as I,ap as u,m as f,n as w}from"./v_7_4_2_7_b7b85612-c64e-4acf-adcb-deb761a9150023.js";import{u as h}from"./v_7_4_2_7_b7b85612-c64e-4acf-adcb-deb761a91500127.js";import{u as E}from"./v_7_4_2_7_b7b85612-c64e-4acf-adcb-deb761a9150019.js";import{P as A,I as g,S as P,G as M}from"./v_7_4_2_7_b7b85612-c64e-4acf-adcb-deb761a9150010.js";import{c as z}from"./v_7_4_2_7_b7b85612-c64e-4acf-adcb-deb761a915007.js";import{u as C}from"./v_7_4_2_7_b7b85612-c64e-4acf-adcb-deb761a9150028.js";import{W as y}from"./v_7_4_2_7_b7b85612-c64e-4acf-adcb-deb761a9150018.js";async function $(t,n=1e4,e=void 0){try{return await Promise.race([t,new Promise(a=>setTimeout(()=>a(e),n))])}catch(a){return console.error("Erro em safeAwait:",a),e}}const R=async t=>{try{const{randomIA:n}=c.getState().config;if(!n)return t;const e=["Refatore a mensagem mantendo a mesma semântica","Entidades imutáveis: preserve nomes, números, datas, prazos, preços, políticas, links e contatos exatamente iguais (não reescreva URLs)","Comprimento: mantenha entre -10% e +10% do tamanho original","Entidades imutáveis: preserve nomes, números, datas, prazos, preços, políticas, links e contatos exatamente iguais","Oferta/CTA: mantenha a mesma oferta; escolha uma CTA apenas da lista fornecida (sem inventar novas)","Variação limitada: sinônimos moderados e pequenas mudanças na ordem das mesmas ideias; conectores e pontuação podem variar","Emojis: Inserir emoji apenas caso necessário e caso tenha pode realizar uma randomização nele desde que mantenha a mesma intenção","Linha: Respeite os espaçamentos de linha, mantendo a estrutura base do texto, como linha quebrada, espaçamentos entre parágrafos, etc.","Gramatica: Valide o texto por completo e corrija gramaticalmente"],a=await y.IA("text",{agente:"Random",question:t,context:e});return a.success?a.response:t}catch(n){return console.error("Error ao adicionar IA",n),t}},l=t=>{var n;try{const e=(n=c==null?void 0:c.getState())==null?void 0:n.chats[0];t=t.replaceAll("#primeiroNome",e.name.split(" ")[0]),t=t.replaceAll("#nomes",e.name),t=t.replaceAll("#nome",e.name);for(const a in e)a&&a.length>0&&e.hasOwnProperty(a)&&(t=t.replaceAll(`#${a}`,e[a]));return t}catch(e){return console.error("Erro ao adicionar a #tag do envio em massa",e),t}},D=async()=>{const{acao:t}=u.getState();return await Promise.all(t.map(async e=>{const a={...e};if(a.type==="txt"||a.type==="image"||a.type==="video"){const s={...a.propriedades};if(s.mensagem){const o=l(s.mensagem);s.mensagem=await R(o)}a.propriedades=s}if(a.type==="linkPreview"){const s={...a.propriedades};s.description&&(s.description=l(s.description)),s.title&&(s.title=l(s.title)),a.propriedades=s}return a}))},p=(t,n)=>{const{statusEnvio:e,setStatusEnvio:a}=c.getState(),{updateRelatorio:s}=C.getState(),o={id:e.index,nome:n.name,phone:n.id.includes("@g.us")?n.id.replace("@g.us",""):n.id.includes("@c.us")?n.id.replace("@c.us",""):n.id,status:"Erro",hora:Date.now()};t?(o.status="Enviado",a({index:e.index+1,success:e.success+1,percent:Math.round((e.index+1)*100/e.total)})):(o.status="Erro",a({index:e.index+1,erro:e.erro+1,percent:Math.round((e.index+1)*100/e.total)})),c.setState(i=>({chats:i.chats.slice(1)})),s({id:e.id.toString(),send:[o]})};async function T(){const{chats:t,setInfo:n}=c.getState(),{assinatura:e}=h.getState(),{language:a}=E.getState(),s=t[0];try{if(s.id==0){s.name="Whatsapp",p(!1,s);return}if(n(`${a.envMassaRemetente} ${s.name}`),s.imported&&await $(y.Contact("queryExists",A(s.id)),7e3,"undefined")==="undefined"){p(!1,s);return}let o=await I(A(s.id),await D(),e,"useAcaoEnvioEmMassa");p(o,s)}catch(o){console.error("Erro ao tentar realizar o envio",o),p(!1,s)}}async function v(){const{statusEnvio:t,config:n,chats:e,setChats:a,setInfo:s,updateIndexDB:o,setStatusEnvio:i,setActiveAgrupamento:r,setTimePause:m}=c.getState(),{clearAcao:S}=u.getState(),{language:d}=E.getState();if(t.index%parseInt(n.pausa)==0&&t.index>0?(s(`${d.envMassaPausa} ${n.tempoPausa} ${d.segundos}`),await x(parseInt(n.tempoPausa)*1e3)):(s(`${d.envMassaIntervalo} ${n.intervalo} ${d.segundos}`),await x(parseInt(n.intervalo)*1e3)),await T(),o(),e[1]===void 0||t.estado==="Finalized"){r({name:"",color:""}),i({estado:"Finalized"}),a([]),i({estado:"Finalized"}),S(),s(d.envMassaFinalized),o(!0);return}if(!f.getState().user.estado&&t.index>4){i({estado:"Paused",pause:!0}),s(d.envMassaPaused),m(!1),g({type:"Info",message:d.envMassaNotLogin,position:"top-right"});return}switch(t.estado){case"Paused":case"Paused-Process":s(d.envMassaPaused),m(!1);break;case"Canceled":o(!0),i({index:0,erro:0,success:0,total:0,percent:0,estado:"Finalized",pause:!1}),s(""),r({name:"",color:""}),S();break;case"Atived":v();break}}function x(t){return new Promise(n=>setTimeout(n,t))}const c=z()((t,n)=>({statusEnvio:{id:0,index:0,erro:0,success:0,total:0,percent:0,estado:"Finalized",pause:!1},setStatusEnvio:e=>t(a=>({statusEnvio:{...a.statusEnvio,...e}})),info:"",setInfo:e=>t({info:e}),chats:[],setChats:e=>t({chats:e}),activeAgrupamento:{name:"",color:""},setActiveAgrupamento:e=>t({activeAgrupamento:e}),send:!1,setSend:e=>t({send:e}),config:{intervalo:"10",pausa:"10",tempoPausa:"60",randomIA:!1},setConfig:(e,a)=>t(s=>({config:{...s.config,[e]:a}})),getVariaveis:()=>{const{chats:e}=n();let a=[];return e.forEach(s=>{Object.keys(s).forEach(o=>{if(!a.includes(o)){if(o==="labels"||o==="imported")return;o==="id"&&(o="numero"),o==="name"&&(o="nome",a.includes("primeiroNome")||a.push("primeiroNome")),a.includes(o)||a.push(o)}})}),a},cancelarEnvio:()=>{const{setStatusEnvio:e,setSend:a,setChats:s,updateIndexDB:o,setActiveAgrupamento:i}=n(),{clearAcao:r}=u.getState(),{setActiveMenu:m}=h.getState();i({name:"",color:""}),s([]),e({estado:"Canceled"}),a(!1),m("Envio Rápido"),r(),o(!0)},timePause:!1,setTimePause:e=>t({timePause:e}),pausePlay:()=>{const{user:e}=f.getState(),{statusEnvio:a,setStatusEnvio:s,timePause:o,setTimePause:i}=n(),{openRendertype:r}=w.getState();if(!e.estado){r("user_free");return}o||(a.pause?(s({estado:"Atived",pause:!1}),v()):(s({estado:"Paused",pause:!0}),i(!0)))},initDisparo:()=>{const{updateIndexDB:e,setSend:a,setStatusEnvio:s,chats:o}=n(),{language:i}=E.getState(),{user:r}=f.getState();r.estado?g({type:"Info",message:`${i.msg_info_janela}`,position:"top-right"}):(g({type:"Info",message:`${i.msg_info_gratuito}`,position:"top-right"}),c.setState({chats:r.estado?o:o.slice(0,5)})),e(),s({id:Date.now(),estado:"Atived",index:0,erro:0,success:0,total:(r.estado?o:o.slice(0,5)).length,percent:0}),a(!0),v()},updateIndexDB:(e=!1)=>{const{chats:a,config:s,statusEnvio:o}=n(),{acao:i}=u.getState();e?P("envioEmMassa","useCampanha",{}):P("envioEmMassa","useCampanha",{chats:a,config:s,acao:i,statusEnvio:o})}}));(async()=>{var n,e;const t=await M("envioEmMassa","useCampanha");t[0]&&((e=(n=t[0])==null?void 0:n.chats)==null?void 0:e.length)>0&&(c.setState({chats:t[0].chats,config:t[0].config,statusEnvio:{...t[0].statusEnvio,estado:"Paused",pause:!0},send:!0,info:"Envio das mensagens Pausado"}),u.setState({acao:t[0].acao}),h.getState().setActiveMenu("Enviar Campanha"))})();export{c as u};
